<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Weekly Timesheet</title>
         
        <!-- Favicon -->
        <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}" />
        <link rel="icon" type="image/png" sizes="32x32" th:href="@{/favicon-32x32.png}" />
        <link rel="icon" type="image/png" sizes="16x16" th:href="@{/favicon-16x16.png}" />
        <link rel="apple-touch-icon" sizes="180x180" th:href="@{/apple-touch-icon.png}" />
        <link rel="manifest" th:href="@{/site.webmanifest}" />
        
        <link rel="stylesheet" th:href="@{/css/base.css}" />
        <link rel="stylesheet" th:href="@{/css/components.css}" />
        <link rel="stylesheet" th:href="@{/css/timesheet.css}" />
        <script>
            // Maintain URL display as /task-activity for weekly timesheet
            document.addEventListener('DOMContentLoaded', function() {
                if (window.location.pathname === '/task-activity/weekly-timesheet') {
                    // Keep current query parameters when changing display URL
                    const currentSearch = window.location.search;
                    window.history.replaceState(null, null, '/task-activity' + currentSearch);
                }
            });
        </script>
        <style>
            /* Page-specific styles only */
            /* Wider layout for timesheet */
            .container {
                max-width: 95% !important;
            }
            .nav-content {
                max-width: 95% !important;
            }
            .day-header {
                background-color: #e9ecef !important;
                font-weight: bold;
                color: #495057;
                border-top: 2px solid #007bff;
            }
            .day-total {
                background-color: #f8f9fa;
                font-weight: bold;
                text-align: right;
                color: #007bff;
            }
            .week-total-row {
                background-color: #007bff;
                color: white;
                font-weight: bold;
                font-size: 16px;
            }
            .week-total-row td {
                padding: 15px 12px;
                border-bottom: none;
            }
            .week-total-row td:nth-child(2) {
                text-align: right;
            }
            .task-hours {
                text-align: right;
                font-weight: bold;
                min-width: 80px;
            }
            .task-client {
                font-weight: 600;
                color: #007bff;
            }
            .task-project {
                color: #6c757d;
                font-style: italic;
            }
            .task-phase {
                color: #28a745;
                font-size: 0.9em;
            }
            .task-details {
                color: #495057;
                max-width: 400px;
                word-wrap: break-word;
            }
            .no-tasks-day {
                text-align: center;
                color: #6c757d;
                font-style: italic;
                padding: 20px;
            }
            .empty-week {
                text-align: center;
                padding: 40px;
                color: #6c757d;
                font-style: italic;
            }
            .week-nav-btn {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                cursor: pointer;
                text-decoration: none;
                font-size: 14px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 32px;
                transition: background-color 0.3s;
            }
            .week-nav-btn:hover {
                background-color: #0056b3;
            }
            .week-nav-btn:disabled {
                background-color: #6c757d;
                cursor: not-allowed;
            }
            /* CSV Modal Styles */
            .csv-modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
            }
            .csv-modal-content {
                background-color: white;
                margin: 5% auto;
                padding: 20px;
                border-radius: 8px;
                width: 90%;
                max-width: 800px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .csv-modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #007bff;
            }
            .csv-modal-header h2 {
                margin: 0;
                color: #007bff;
            }
            .csv-close {
                color: #aaa;
                font-size: 28px;
                font-weight: bold;
                cursor: pointer;
                background: none;
                border: none;
                padding: 0;
                line-height: 1;
            }
            .csv-close:hover,
            .csv-close:focus {
                color: #000;
            }
            .csv-textarea {
                width: 100%;
                min-height: 300px;
                font-family: 'Courier New', monospace;
                font-size: 12px;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                resize: vertical;
            }
            .csv-actions {
                margin-top: 15px;
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }
            @media (max-width: 768px) {
                .header {
                    flex-direction: column;
                    gap: 10px;
                    text-align: center;
                }
                .date-selector {
                    flex-direction: column;
                    gap: 10px;
                    text-align: center;
                }
                .week-navigation {
                    justify-content: center;
                }
                .timesheet-table th,
                .timesheet-table td {
                    padding: 6px 4px;
                    font-size: 12px;
                }
                .task-details {
                    max-width: 200px;
                }
            }
        </style>
    </head>
    <body>
        <nav class="navbar">
            <div class="nav-content">
                <h1>Task Activity Tracker</h1>
                <div class="user-info">
                    <div style="display: inline-flex; align-items: center; gap: 15px;">
                        <div th:if="${passwordExpiringWarning}"
                             style="background-color: #fff3cd; color: #856404; padding: 8px 12px; border-radius: 4px; font-size: 13px; border: 1px solid #ffc107;">
                            <span th:text="${passwordExpiringWarning}"></span>
                        </div>
                        <span class="welcome-text">
                            <span th:text="${userDisplayName}">Username</span>
                        </span>
                    </div>
                    <form th:action="@{/logout}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-secondary btn-sm">Logout</button>
                    </form>
                    <span class="current-date" style="margin-left: 15px; font-size: 14px;">
                        <script>
                            document.write(new Date().toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' }));
                        </script>
                    </span>
                </div>
                </div>
            </div>
        </nav>
        
        <!-- Welcome Banner for GUEST users only -->
        <div sec:authorize="hasRole('GUEST')" 
             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 12px 20px;
                    margin: 0;
                    text-align: center;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="max-width: 1400px; margin: 0 auto;">
                <strong style="font-size: 15px;">ðŸ‘‹ Welcome, Guest!</strong>
                <span style="margin-left: 10px; font-size: 13px;">
                    You can create and edit your own tasks and view the weekly timesheet. 
                    Other features are visible but read-only to allow exposure to the full application functionality.
                </span>
            </div>
        </div>
        
        <div class="container">
            <div class="header">
                <div>
                    <h1>Weekly Timesheet</h1>
                    <div class="week-info" th:if="${weeklyData}">
                        Week of
                        <span
                            th:text="${#temporals.format(weeklyData.weekStartDate, 'MMM dd')}"
                        ></span>
                        -
                        <span
                            th:text="${#temporals.format(weeklyData.weekEndDate, 'MMM dd, yyyy')}"
                        ></span>
                    </div>
                </div>
                <div>
                    <a
                        th:href="@{/task-activity/list}"
                        class="btn btn-secondary"
                        >Task Activity List</a
                    >
                    <button
                        type="button"
                        class="btn btn-secondary"
                        id="exportCsvBtn"
                        title="Export to CSV"
                        th:disabled="${#authorization.expression('hasRole(''GUEST'')')}"
                        >Export CSV</button
                    >
                    <a th:href="@{/task-activity/add}" 
                       class="btn btn-primary"
                        >Add Task</a
                    >
                </div>
            </div>

            <!-- Date Selector -->
            <div class="date-selector">
                <label for="weekStartDate">Week Starting Monday:</label>
                <input
                    type="date"
                    id="weekStartDate"
                    name="weekStartDate"
                    th:value="${weeklyData != null ? weeklyData.weekStartDate : ''}"
                />
                <div class="week-navigation">
                    <button type="button" class="week-nav-btn" id="prevWeek" title="Previous Week">â€¹</button>
                    <button type="button" class="week-nav-btn" id="nextWeek" title="Next Week">â€º</button>
                    <button type="button" class="btn btn-secondary" id="currentWeek">Current Week</button>
                </div>
            </div>

            <!-- Billability Filter -->
            <div class="date-selector" style="margin-top: 15px;">
                <label for="billability Filter">Billability:</label>
                <select id="billabilityFilter" name="billability" onchange="applyBillabilityFilter()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 150px;">
                    <option value="All" th:selected="${billability == null or billability == 'All'}">All</option>
                    <option value="Billable" th:selected="${billability == 'Billable'}">Billable</option>
                    <option value="Non-Billable" th:selected="${billability == 'Non-Billable'}">Non-Billable</option>
                </select>
            </div>

            <!-- Error Message -->
            <div
                th:if="${errorMessage}"
                class="error-message"
                th:text="${errorMessage}"
            ></div>

            <!-- Weekly Timesheet Table -->
            <div th:if="${weeklyData}">
                <table class="timesheet-table">
                    <thead>
                        <tr>
                            <th style="width: 300px">Client</th>
                            <th style="width: 250px">Project</th>
                            <th style="width: 130px">Phase</th>
                            <th style="width: 80px">Hours</th>
                            <th>Task</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Loop through all days (Monday-Sunday) -->
                        <th:block th:each="dailyData : ${weeklyData.allDays}">
                            <!-- Only show days that have tasks -->
                            <th:block th:if="${dailyData.hasTasks()}">
                                <!-- Day Header -->
                                <tr class="day-header">
                                    <td colspan="5">
                                        <span
                                            th:text="${dailyData.dayName}"
                                        ></span>
                                        <span
                                            th:text="${#temporals.format(dailyData.date, 'MM/dd/yyyy')}"
                                        ></span>
                                    </td>
                                </tr>

                                <!-- Tasks for this day -->
                                <tr th:each="task : ${dailyData.tasks}">
                                    <td
                                        class="task-client"
                                        th:text="${task.client}"
                                    ></td>
                                    <td
                                        class="task-project"
                                        th:text="${task.project}"
                                    ></td>
                                    <td
                                        class="task-phase"
                                        th:text="${task.phase}"
                                    ></td>
                                    <td
                                        class="task-hours"
                                        th:text="${#numbers.formatDecimal(task.hours, 1, 2)}"
                                        th:style="${@billabilityService.isTaskBillable(task.client, task.project, task.phase) ? '' : 'color: red; font-weight: bold;'}"
                                    ></td>
                                    <td
                                        class="task-details"
                                        th:text="${task.details}"
                                    ></td>
                                </tr>

                                <!-- Day Total -->
                                <tr class="day-total">
                                    <td colspan="3"></td>
                                    <td
                                        th:text="${#numbers.formatDecimal(dailyData.dayTotal, 1, 2)}"
                                    ></td>
                                    <td></td>
                                </tr>
                            </th:block>
                        </th:block>

                        <!-- Week Total -->
                        <tr class="week-total-row">
                            <td colspan="3"><strong>Total Hours</strong></td>
                            <td>
                                <strong
                                    th:text="${#numbers.formatDecimal(weeklyData.weekTotal, 1, 2)}"
                                ></strong>
                            </td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>

                <!-- Empty week message -->
                <div
                    class="empty-week"
                    th:if="${weeklyData.weekTotal.compareTo(T(java.math.BigDecimal).ZERO) == 0}"
                >
                    No tasks recorded for this week.
                </div>
            </div>
        </div>

        <!-- CSV Export Modal -->
        <div id="csvModal" class="csv-modal">
            <div class="csv-modal-content">
                <div class="csv-modal-header">
                    <h2>Export Weekly Timesheet to CSV</h2>
                    <button class="csv-close" id="csvCloseBtn">&times;</button>
                </div>
                <p>Copy the CSV data below:</p>
                <textarea id="csvOutput" class="csv-textarea" readonly></textarea>
                <div class="csv-actions">
                    <button class="btn btn-primary" id="copyCsvBtn">Copy to Clipboard</button>
                    <button class="btn btn-secondary" id="downloadCsvBtn">Download CSV</button>
                    <button class="btn btn-secondary" id="closeCsvBtn">Close</button>
                </div>
            </div>
        </div>

        <script src="/js/date-utils.js"></script>
        <script>
            // Initialize date picker with current or URL date
            function initializeDatePicker() {
                const dateInput = document.getElementById('weekStartDate');
                const monday = DateUtils.getCurrentOrUrlMonday('date');
                dateInput.value = DateUtils.formatDateForInput(monday);
            }

            // Set up event listeners
            document.addEventListener('DOMContentLoaded', function() {
                initializeDatePicker();

                const dateInput = document.getElementById('weekStartDate');
                const prevWeekBtn = document.getElementById('prevWeek');
                const nextWeekBtn = document.getElementById('nextWeek');
                const currentWeekBtn = document.getElementById('currentWeek');

                // Handle date input change
                dateInput.addEventListener('change', function() {
                    if (!this.value) return; // Don't proceed if no value

                    const selectedDate = DateUtils.parseDate(this.value);
                    const monday = DateUtils.getMondayOfWeek(selectedDate);
                    const mondayStr = DateUtils.formatDateForInput(monday);

                    // Update input to show the calculated Monday if different
                    if (this.value !== mondayStr) {
                        this.value = mondayStr;
                    }

                    // Update the URL to reload with new date
                    DateUtils.updateUrl(mondayStr, '/task-activity/weekly-timesheet');
                });

                // Handle previous week button
                prevWeekBtn.addEventListener('click', function() {
                    const currentDate = DateUtils.parseDate(dateInput.value);
                    const prevWeek = DateUtils.addDays(currentDate, -7);
                    const prevWeekStr = DateUtils.formatDateForInput(prevWeek);
                    DateUtils.updateUrl(prevWeekStr, '/task-activity/weekly-timesheet');
                });

                // Handle next week button
                nextWeekBtn.addEventListener('click', function() {
                    const currentDate = DateUtils.parseDate(dateInput.value);
                    const nextWeek = DateUtils.addDays(currentDate, 7);
                    const nextWeekStr = DateUtils.formatDateForInput(nextWeek);
                    DateUtils.updateUrl(nextWeekStr, '/task-activity/weekly-timesheet');
                });

                // Handle current week button
                currentWeekBtn.addEventListener('click', function() {
                    DateUtils.updateUrl(null, '/task-activity/weekly-timesheet'); // Remove date parameter to show current week
                });
            });

            // Handle billability filter change
            function applyBillabilityFilter() {
                const billabilityFilter = document.getElementById('billabilityFilter');
                const dateInput = document.getElementById('weekStartDate');
                const currentDate = dateInput.value;
                
               // Build URL with date and billability parameters
                const params = new URLSearchParams();
                if (currentDate) {
                    params.append('date', currentDate);
                }
                const billability = billabilityFilter.value;
                if (billability && billability !== 'All') {
                    params.append('billability', billability);
                }
                
                window.location.href = '/task-activity/weekly-timesheet?' + params.toString();
            }

            // CSV Export Functionality
            function generateCSV() {
                const csvRows = [];
                
                // Add header row
                csvRows.push('Date,Client,Project,Phase,Hours,Task Details,Username');
                
                // Get all task rows from the table
                const table = document.querySelector('.timesheet-table');
                if (!table) {
                    return 'No data available to export';
                }
                
                let currentDate = '';
                
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    // Check if it's a day header
                    if (row.classList.contains('day-header')) {
                        const headerText = row.textContent.trim().replace(/\s+/g, ' ');
                        // Extract just the date (MM/DD/YYYY format)
                        const dateMatch = headerText.match(/(\d{2}\/\d{2}\/\d{4})/);
                        if (dateMatch) {
                            currentDate = dateMatch[1];
                        }
                    } 
                    // Skip day totals and week totals
                    else if (row.classList.contains('day-total') || row.classList.contains('week-total-row')) {
                        return;
                    }
                    // Process task rows
                    else {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 5) {
                            const client = cells[0].textContent.trim();
                            const project = cells[1].textContent.trim();
                            const phase = cells[2].textContent.trim();
                            const hours = cells[3].textContent.trim();
                            const details = cells[4].textContent.trim().replace(/\s+/g, ' ');
                            
                            // Get username from the page (from welcome text)
                            const usernameElement = document.querySelector('.welcome-text span');
                            const username = usernameElement ? usernameElement.textContent.trim() : '';
                            
                            // Escape fields that might contain commas or quotes
                            const escapeCsvField = (field) => {
                                if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                                    return '"' + field.replace(/"/g, '""') + '"';
                                }
                                return field;
                            };
                            
                            csvRows.push([
                                currentDate,
                                escapeCsvField(client),
                                escapeCsvField(project),
                                escapeCsvField(phase),
                                hours,
                                escapeCsvField(details),
                                escapeCsvField(username)
                            ].join(','));
                        }
                    }
                });
                
                return csvRows.join('\n');
            }

            // CSV Modal functionality
            document.addEventListener('DOMContentLoaded', function() {
                const modal = document.getElementById('csvModal');
                const exportBtn = document.getElementById('exportCsvBtn');
                const closeBtn = document.getElementById('csvCloseBtn');
                const closeCsvBtn = document.getElementById('closeCsvBtn');
                const copyCsvBtn = document.getElementById('copyCsvBtn');
                const downloadCsvBtn = document.getElementById('downloadCsvBtn');
                const csvOutput = document.getElementById('csvOutput');

                // Open modal and generate CSV
                if (exportBtn) {
                    exportBtn.addEventListener('click', function() {
                        const csv = generateCSV();
                        csvOutput.value = csv;
                        modal.style.display = 'block';
                    });
                }

                // Close modal handlers
                const closeModal = () => {
                    modal.style.display = 'none';
                };

                if (closeBtn) closeBtn.addEventListener('click', closeModal);
                if (closeCsvBtn) closeCsvBtn.addEventListener('click', closeModal);

                // Close when clicking outside modal
                window.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeModal();
                    }
                });

                // Copy to clipboard
                if (copyCsvBtn) {
                    copyCsvBtn.addEventListener('click', function() {
                        csvOutput.select();
                        navigator.clipboard.writeText(csvOutput.value).then(() => {
                            const originalText = copyCsvBtn.textContent;
                            copyCsvBtn.textContent = 'âœ“ Copied!';
                            copyCsvBtn.style.backgroundColor = '#28a745';
                            setTimeout(() => {
                                copyCsvBtn.textContent = originalText;
                                copyCsvBtn.style.backgroundColor = '';
                            }, 2000);
                        }).catch(err => {
                            alert('Failed to copy to clipboard. Please select and copy manually.');
                        });
                    });
                }

                // Download CSV
                if (downloadCsvBtn) {
                    downloadCsvBtn.addEventListener('click', function() {
                        const csv = csvOutput.value;
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        
                        // Generate filename with date range in MM/DD/YYYY format
                        let filename = 'Timesheet.csv';
                        
                        // Get start and end dates from the weeklyData
                        const weekStartElement = document.querySelector('.week-info span:first-of-type');
                        const weekEndElement = document.querySelector('.week-info span:last-of-type');
                        
                        if (weekStartElement && weekEndElement) {
                            // Parse the dates - they're in format like "Oct 27" and "Nov 02, 2025"
                            const startText = weekStartElement.textContent.trim();
                            const endText = weekEndElement.textContent.trim();
                            
                            // Get the year from end date
                            const yearMatch = endText.match(/\d{4}/);
                            const year = yearMatch ? yearMatch[0] : new Date().getFullYear();
                            
                            // Convert month names to numbers
                            const monthMap = {
                                'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
                                'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
                                'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
                            };
                            
                            // Parse start date (e.g., "Oct 27")
                            const startParts = startText.match(/(\w+)\s+(\d+)/);
                            if (startParts) {
                                const startMonth = monthMap[startParts[1]];
                                const startDay = startParts[2].padStart(2, '0');
                                const startDate = startMonth + '/' + startDay + '/' + year;
                                
                                // Parse end date (e.g., "Nov 02, 2025")
                                const endParts = endText.match(/(\w+)\s+(\d+)/);
                                if (endParts) {
                                    const endMonth = monthMap[endParts[1]];
                                    const endDay = endParts[2].padStart(2, '0');
                                    const endDate = endMonth + '/' + endDay + '/' + year;
                                    
                                    filename = 'Timesheet_Week_of_' + startDate.replace(/\//g, '-') + '_to_' + endDate.replace(/\//g, '-') + '.csv';
                                }
                            }
                        }
                        
                        link.setAttribute('href', url);
                        link.setAttribute('download', filename);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    });
                }
            });
        </script>
    </body>
</html>
