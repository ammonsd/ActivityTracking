<!DOCTYPE html>
<html
    lang="en"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Guest Activity Report</title>

        <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}" />
        <link rel="stylesheet" th:href="@{/css/base.css}" />
        <link rel="stylesheet" th:href="@{/css/components.css}" />

        <style>
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            .stat-card {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .stat-value {
                font-size: 32px;
                font-weight: bold;
                margin-bottom: 5px;
            }
            .stat-label {
                font-size: 14px;
                opacity: 0.9;
            }
            .audit-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            .audit-table th,
            .audit-table td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }
            .audit-table th {
                background-color: #f8f9fa;
                font-weight: 600;
            }
            .audit-table tr:hover {
                background-color: #f8f9fa;
            }
            .status-badge {
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
            }
            .status-success {
                background-color: #d4edda;
                color: #155724;
            }
            .status-failed {
                background-color: #f8d7da;
                color: #721c24;
            }
            .loading {
                text-align: center;
                padding: 40px;
                color: #666;
            }
            /* CSV Modal Styles */
            .csv-modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
            }
            .csv-modal-content {
                background-color: white;
                margin: 5% auto;
                padding: 20px;
                border-radius: 8px;
                width: 80%;
                max-width: 800px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .csv-modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            .csv-close {
                background: none;
                border: none;
                font-size: 28px;
                cursor: pointer;
                color: #999;
            }
            .csv-close:hover {
                color: #333;
            }
            .csv-textarea {
                width: 100%;
                height: 300px;
                font-family: monospace;
                font-size: 12px;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                resize: vertical;
            }
            .csv-actions {
                display: flex;
                gap: 10px;
                margin-top: 15px;
            }
        </style>
    </head>

    <body>
        <nav class="navbar">
            <div class="nav-content">
                <h1>Task Activity Tracker</h1>
                <div class="user-info">
                    <span class="welcome-text">
                        <span th:text="${userDisplayName}">Username</span>
                    </span>
                    <form
                        th:action="@{/logout}"
                        method="post"
                        style="margin: 0"
                    >
                        <button type="submit" class="btn btn-secondary btn-sm">
                            Logout
                        </button>
                    </form>
                </div>
            </div>
        </nav>

        <div class="container">
            <div class="header">
                <h1>üìä Guest Activity Report</h1>
                <div>
                    <button
                        id="exportCsvBtn"
                        class="btn btn-success"
                        style="margin-right: 10px"
                        onclick="exportToCSV()"
                    >
                        üì• Export CSV
                    </button>
                    <a th:href="@{/task-activity}" class="btn btn-secondary">
                        ‚Üê Back to Tasks
                    </a>
                </div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalLogins">-</div>
                    <div class="stat-label">Total Logins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniqueLocations">-</div>
                    <div class="stat-label">Unique Locations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastLogin">-</div>
                    <div class="stat-label">Last Login</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="successRate">-</div>
                    <div class="stat-label">Success Rate</div>
                </div>
            </div>

            <h2>Recent Login Activity</h2>
            <div id="auditTableContainer">
                <div class="loading">Loading audit data...</div>
            </div>
        </div>

        <!-- CSV Export Modal -->
        <div id="csvModal" class="csv-modal">
            <div class="csv-modal-content">
                <div class="csv-modal-header">
                    <h2>Export Guest Login Audit to CSV</h2>
                    <button class="csv-close" id="csvCloseBtn">&times;</button>
                </div>
                <p>Copy the CSV data below:</p>
                <textarea
                    id="csvOutput"
                    class="csv-textarea"
                    readonly
                ></textarea>
                <div class="csv-actions">
                    <button class="btn btn-primary" id="copyCsvBtn">
                        üìã Copy to Clipboard
                    </button>
                    <button class="btn btn-secondary" id="downloadCsvBtn">
                        üíæ Download CSV
                    </button>
                    <button class="btn btn-secondary" id="closeCsvBtn">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Fetch login audit data from API
            fetch("/api/users/login-audit?username=guest&limit=100")
                .then((response) => response.json())
                .then((apiResponse) => {
                    if (apiResponse.success && apiResponse.data) {
                        const auditData = apiResponse.data;

                        // Calculate statistics
                        const totalLogins = auditData.length;
                        const uniqueLocations = new Set(
                            auditData.map((a) => a.location)
                        ).size;
                        const successfulLogins = auditData.filter(
                            (a) => a.successful
                        ).length;
                        const successRate =
                            totalLogins > 0
                                ? Math.round(
                                      (successfulLogins / totalLogins) * 100
                                  )
                                : 0;

                        // Update stats
                        document.getElementById("totalLogins").textContent =
                            totalLogins;
                        document.getElementById("uniqueLocations").textContent =
                            uniqueLocations;
                        document.getElementById("successRate").textContent =
                            successRate + "%";

                        if (auditData.length > 0) {
                            const lastLoginDate = new Date(
                                auditData[0].loginTime
                            );
                            document.getElementById("lastLogin").textContent =
                                lastLoginDate.toLocaleDateString("en-US", {
                                    month: "short",
                                    day: "numeric",
                                });
                        }

                        // Build table
                        let tableHtml = `
                            <table class="audit-table">
                                <thead>
                                    <tr>
                                        <th>Date/Time</th>
                                        <th>IP Address</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        auditData.forEach((audit) => {
                            const loginDate = new Date(audit.loginTime);
                            const formattedDate = loginDate.toLocaleString(
                                "en-US",
                                {
                                    year: "numeric",
                                    month: "short",
                                    day: "numeric",
                                    hour: "2-digit",
                                    minute: "2-digit",
                                }
                            );

                            const statusClass = audit.successful
                                ? "status-success"
                                : "status-failed";
                            const statusText = audit.successful
                                ? "Success"
                                : "Failed";

                            tableHtml += `
                                <tr>
                                    <td>${formattedDate}</td>
                                    <td>${audit.ipAddress || "Unknown"}</td>
                                    <td>${audit.location || "Unknown"}</td>
                                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                </tr>
                            `;
                        });

                        tableHtml += `
                                </tbody>
                            </table>
                        `;

                        document.getElementById(
                            "auditTableContainer"
                        ).innerHTML = tableHtml;
                    } else {
                        document.getElementById(
                            "auditTableContainer"
                        ).innerHTML =
                            '<div class="loading">No audit data available</div>';
                    }
                })
                .catch((error) => {
                    console.error("Error loading audit data:", error);
                    document.getElementById("auditTableContainer").innerHTML =
                        '<div class="loading" style="color: red;">Error loading audit data</div>';
                });

            // Export audit data to CSV with modal
            function exportToCSV() {
                fetch("/api/users/login-audit?username=guest&limit=1000")
                    .then((response) => response.json())
                    .then((apiResponse) => {
                        if (
                            apiResponse.success &&
                            apiResponse.data &&
                            apiResponse.data.length > 0
                        ) {
                            const auditData = apiResponse.data;

                            // Create CSV header
                            let csv = "Date/Time,IP Address,Location,Status\n";

                            // Add data rows
                            auditData.forEach((audit) => {
                                const loginDate = new Date(audit.loginTime);
                                const formattedDate = loginDate.toLocaleString(
                                    "en-US",
                                    {
                                        year: "numeric",
                                        month: "short",
                                        day: "numeric",
                                        hour: "2-digit",
                                        minute: "2-digit",
                                        second: "2-digit",
                                    }
                                );

                                const status = audit.successful
                                    ? "Success"
                                    : "Failed";
                                const ipAddress = audit.ipAddress || "Unknown";
                                const location = audit.location || "Unknown";

                                // Escape fields that might contain commas
                                csv += `"${formattedDate}","${ipAddress}","${location}","${status}"\n`;
                            });

                            // Populate textarea and show modal
                            document.getElementById("csvOutput").value = csv;
                            document.getElementById("csvModal").style.display =
                                "block";
                        } else {
                            alert("No audit data available to export");
                        }
                    })
                    .catch((error) => {
                        console.error("Error exporting audit data:", error);
                        alert("Error exporting audit data");
                    });
            }

            // Copy CSV to clipboard
            document
                .getElementById("copyCsvBtn")
                .addEventListener("click", function () {
                    const csvText = document.getElementById("csvOutput").value;

                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard
                            .writeText(csvText)
                            .then(() => {
                                alert("CSV data copied to clipboard!");
                            })
                            .catch(() => {
                                // Fallback method
                                fallbackCopyToClipboard(csvText);
                            });
                    } else {
                        // Fallback for older browsers
                        fallbackCopyToClipboard(csvText);
                    }
                });

            // Fallback copy method for older browsers
            function fallbackCopyToClipboard(text) {
                const textarea = document.getElementById("csvOutput");
                textarea.select();
                try {
                    document.execCommand("copy");
                    alert("CSV data copied to clipboard!");
                } catch (err) {
                    alert("Failed to copy to clipboard");
                }
            }

            // Download CSV file
            document
                .getElementById("downloadCsvBtn")
                .addEventListener("click", function () {
                    const csvText = document.getElementById("csvOutput").value;
                    const blob = new Blob([csvText], {
                        type: "text/csv;charset=utf-8;",
                    });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);

                    const now = new Date();
                    const filename = `guest_login_audit_${now.getFullYear()}-${String(
                        now.getMonth() + 1
                    ).padStart(2, "0")}-${String(now.getDate()).padStart(
                        2,
                        "0"
                    )}.csv`;

                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = "hidden";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    alert("CSV file downloaded!");
                });

            // Close modal buttons
            document
                .getElementById("closeCsvBtn")
                .addEventListener("click", function () {
                    document.getElementById("csvModal").style.display = "none";
                });

            document
                .getElementById("csvCloseBtn")
                .addEventListener("click", function () {
                    document.getElementById("csvModal").style.display = "none";
                });

            // Close modal when clicking outside
            window.addEventListener("click", function (event) {
                const modal = document.getElementById("csvModal");
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            });
        </script>
    </body>
</html>
