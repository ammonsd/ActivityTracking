<!DOCTYPE html>
<html
    lang="en"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Expense Approval Queue</title>

        <!-- Favicon -->
        <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}" />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            th:href="@{/favicon-32x32.png}"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            th:href="@{/favicon-16x16.png}"
        />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            th:href="@{/apple-touch-icon.png}"
        />
        <link rel="manifest" th:href="@{/site.webmanifest}" />

        <link rel="stylesheet" th:href="@{/css/base.css}" />
        <link rel="stylesheet" th:href="@{/css/components.css}" />
        <script>
            // Maintain URL display as /expense
            document.addEventListener("DOMContentLoaded", function () {
                if (globalThis.location.pathname !== "/expense") {
                    globalThis.history.replaceState(null, null, "/expense");
                }
            });
        </script>
        <style>
            /* Page-specific styles */
            .container {
                max-width: 1600px;
            }
            .nav-content {
                max-width: 1600px;
            }
            .expense-card {
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
                background-color: white;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .expense-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding-bottom: 15px;
                border-bottom: 2px solid #007bff;
            }
            .expense-card-title {
                font-size: 18px;
                font-weight: bold;
                color: #007bff;
            }
            .status-badge {
                display: inline-block;
                padding: 6px 12px;
                border-radius: 4px;
                font-size: 14px;
                font-weight: bold;
            }
            .status-submitted {
                background-color: #17a2b8;
                color: white;
            }
            .status-resubmitted {
                background-color: #ffc107;
                color: black;
            }
            .expense-details {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
                margin-bottom: 15px;
            }
            .detail-item {
                display: flex;
                flex-direction: column;
            }
            .detail-label {
                font-weight: bold;
                color: #6c757d;
                font-size: 12px;
                margin-bottom: 5px;
            }
            .detail-value {
                color: #495057;
                font-size: 14px;
            }
            .amount-highlight {
                font-size: 20px;
                font-weight: bold;
                color: #007bff;
            }
            .expense-actions {
                display: flex;
                gap: 10px;
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid #dee2e6;
            }
            .no-expenses {
                text-align: center;
                padding: 60px 20px;
                color: #6c757d;
                font-style: italic;
            }
            .no-expenses h3 {
                color: #495057;
                margin-bottom: 10px;
            }
            .approval-note {
                background-color: #d1ecf1;
                border: 1px solid #bee5eb;
                border-radius: 4px;
                padding: 15px;
                margin-bottom: 20px;
                color: #0c5460;
            }
            .rejection-form {
                background-color: #f8f9fa;
                padding: 15px;
                border-radius: 4px;
                margin-top: 10px;
            }
            .rejection-form textarea {
                width: 100%;
                min-height: 80px;
                padding: 10px;
                border: 1px solid #ced4da;
                border-radius: 4px;
                font-family: inherit;
                resize: vertical;
            }
            .rejection-form .form-actions {
                display: flex;
                gap: 10px;
                margin-top: 10px;
            }
            /* Approval notes form */
            .approval-notes-form {
                background-color: #f8f9fa;
                padding: 15px;
                border-radius: 4px;
                margin-top: 10px;
            }
            .approval-notes-form textarea {
                width: 100%;
                min-height: 60px;
                padding: 10px;
                border: 1px solid #ced4da;
                border-radius: 4px;
                font-family: inherit;
                resize: vertical;
            }
            .approval-notes-form .form-actions {
                display: flex;
                gap: 10px;
                margin-top: 10px;
            }
            @media (max-width: 768px) {
                .expense-card-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 10px;
                }
                .expense-details {
                    grid-template-columns: 1fr;
                }
                .expense-actions {
                    flex-direction: column;
                }
            }
        </style>
    </head>
    <body>
        <nav class="navbar">
            <div class="nav-content">
                <h1>Task Activity Tracker</h1>
                <div class="user-info">
                    <div
                        style="
                            display: inline-flex;
                            align-items: center;
                            gap: 15px;
                        "
                    >
                        <span class="welcome-text">
                            <span th:text="${userDisplayName}">Username</span>
                        </span>
                        <form
                            th:action="@{/logout}"
                            method="post"
                            style="margin: 0"
                        >
                            <button
                                type="submit"
                                class="btn btn-secondary btn-sm"
                            >
                                Logout
                            </button>
                        </form>
                        <span
                            class="current-date"
                            style="font-size: 14px; white-space: nowrap"
                        >
                            <script>
                                document.write(
                                    new Date().toLocaleDateString("en-US", {
                                        weekday: "short",
                                        year: "numeric",
                                        month: "long",
                                        day: "numeric",
                                    })
                                );
                            </script>
                        </span>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container">
            <div class="header">
                <h1>Expense Approval Queue</h1>
                <div>
                    <!-- Task Activity List -->
                    <a
                        th:href="@{/task-activity/list}"
                        class="btn btn-success"
                        style="margin-right: 10px"
                        title="Task Activity List"
                        >üìã Task Activity List</a
                    >
                    <a th:href="@{/expenses/list}" class="btn btn-secondary">
                        Back to Expense List
                    </a>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div
                th:if="${successMessage}"
                class="success-message"
                th:text="${successMessage}"
            ></div>
            <div
                th:if="${errorMessage}"
                class="error-message"
                th:text="${errorMessage}"
            ></div>

            <!-- Approval Note -->
            <div class="approval-note">
                <strong>‚ÑπÔ∏è Approval Queue</strong><br />
                Review and approve or reject expense submissions below. You can
                add optional notes when approving or must provide a reason when
                rejecting.
            </div>

            <!-- Pending Expenses -->
            <div th:if="${not #lists.isEmpty(pendingExpenses)}">
                <div
                    th:each="expense : ${pendingExpenses}"
                    class="expense-card"
                >
                    <div class="expense-card-header">
                        <div>
                            <div class="expense-card-title">
                                Expense #<span th:text="${expense.id}"></span> -
                                <span th:text="${expense.username}"></span>
                            </div>
                            <div
                                style="
                                    color: #6c757d;
                                    font-size: 13px;
                                    margin-top: 5px;
                                "
                            >
                                Submitted:
                                <span
                                    th:text="${#temporals.format(expense.submittedDate, 'MMM dd, yyyy HH:mm')}"
                                ></span>
                            </div>
                        </div>
                        <span
                            th:class="'status-badge status-' + ${#strings.toLowerCase(expense.expenseStatus)}"
                            th:text="${expense.expenseStatus}"
                        ></span>
                    </div>

                    <div class="expense-details">
                        <div class="detail-item">
                            <span class="detail-label">Expense Date</span>
                            <span
                                class="detail-value"
                                th:text="${#temporals.format(expense.expenseDate, 'MMM dd, yyyy')}"
                            ></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Client</span>
                            <span
                                class="detail-value"
                                th:text="${expense.client}"
                            ></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Project</span>
                            <span
                                class="detail-value"
                                th:text="${expense.project}"
                            ></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Expense Type</span>
                            <span
                                class="detail-value"
                                th:text="${expense.expenseType}"
                            ></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Amount</span>
                            <span
                                class="detail-value amount-highlight"
                                th:text="${expense.currency + ' ' + #numbers.formatDecimal(expense.amount, 1, 2)}"
                            ></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Payment Method</span>
                            <span
                                class="detail-value"
                                th:text="${expense.paymentMethod}"
                            ></span>
                        </div>
                        <div
                            class="detail-item"
                            th:if="${expense.vendor != null and !expense.vendor.isEmpty()}"
                        >
                            <span class="detail-label">Vendor</span>
                            <span
                                class="detail-value"
                                th:text="${expense.vendor}"
                            ></span>
                        </div>
                        <div
                            class="detail-item"
                            th:if="${expense.referenceNumber != null and !expense.referenceNumber.isEmpty()}"
                        >
                            <span class="detail-label">Reference Number</span>
                            <span
                                class="detail-value"
                                th:text="${expense.referenceNumber}"
                            ></span>
                        </div>
                    </div>

                    <div class="detail-item" style="grid-column: 1 / -1">
                        <span class="detail-label">Description</span>
                        <span
                            class="detail-value"
                            th:text="${expense.description}"
                        ></span>
                    </div>

                    <div
                        class="detail-item"
                        style="grid-column: 1 / -1"
                        th:if="${expense.notes != null and !expense.notes.isEmpty()}"
                    >
                        <span class="detail-label">Additional Notes</span>
                        <span
                            class="detail-value"
                            th:text="${expense.notes}"
                        ></span>
                    </div>

                    <!-- Receipt Link -->
                    <div
                        style="margin-top: 15px"
                        th:if="${expense.receiptPath != null and !expense.receiptPath.isEmpty()}"
                    >
                        <a
                            th:href="@{'/expenses/receipt/' + ${expense.id}}"
                            target="_blank"
                            class="btn btn-info btn-sm"
                            >üìé View Receipt</a
                        >
                    </div>

                    <!-- Actions -->
                    <div class="expense-actions">
                        <!-- View Detail -->
                        <a
                            th:href="@{'/expenses/detail/' + ${expense.id}}"
                            class="btn btn-secondary"
                            >View Full Details</a
                        >

                        <!-- Approve Button -->
                        <button
                            type="button"
                            class="btn btn-success"
                            th:onclick="'showApprovalForm(' + ${expense.id} + ')'"
                        >
                            ‚úì Approve
                        </button>

                        <!-- Reject Button -->
                        <button
                            type="button"
                            class="btn btn-danger"
                            th:onclick="'showRejectionForm(' + ${expense.id} + ')'"
                        >
                            ‚úó Reject
                        </button>
                    </div>

                    <!-- Approval Notes Form (Hidden by default) -->
                    <div
                        th:id="'approval-form-' + ${expense.id}"
                        class="approval-notes-form"
                        style="display: none"
                    >
                        <form
                            th:action="@{'/expenses/' + ${expense.id} + '/approve'}"
                            method="post"
                        >
                            <label
                                for="approvalNotes"
                                style="
                                    font-weight: bold;
                                    display: block;
                                    margin-bottom: 5px;
                                "
                            >
                                Approval Notes (Optional):
                            </label>
                            <textarea
                                id="approvalNotes"
                                name="approvalNotes"
                                placeholder="Add any notes about this approval (optional)..."
                            ></textarea>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">
                                    Confirm Approval
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-secondary"
                                    th:onclick="'hideApprovalForm(' + ${expense.id} + ')'"
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Rejection Form (Hidden by default) -->
                    <div
                        th:id="'rejection-form-' + ${expense.id}"
                        class="rejection-form"
                        style="display: none"
                    >
                        <form
                            th:action="@{'/expenses/' + ${expense.id} + '/reject'}"
                            method="post"
                        >
                            <label
                                for="rejectionReason"
                                style="
                                    font-weight: bold;
                                    display: block;
                                    margin-bottom: 5px;
                                "
                            >
                                Rejection Reason (Required):
                            </label>
                            <textarea
                                id="rejectionReason"
                                name="rejectionReason"
                                required
                                placeholder="Please provide a clear reason for rejecting this expense..."
                            ></textarea>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-danger">
                                    Confirm Rejection
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-secondary"
                                    th:onclick="'hideRejectionForm(' + ${expense.id} + ')'"
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- No Pending Expenses -->
            <div th:if="${#lists.isEmpty(pendingExpenses)}" class="no-expenses">
                <h3>‚úì All Caught Up!</h3>
                <p>There are no expenses pending approval at this time.</p>
                <a
                    th:href="@{/expenses/list}"
                    class="btn btn-primary"
                    style="margin-top: 20px"
                >
                    View All Expenses
                </a>
            </div>
        </div>

        <script>
            function showApprovalForm(expenseId) {
                document.getElementById(
                    "approval-form-" + expenseId
                ).style.display = "block";
                document.getElementById(
                    "rejection-form-" + expenseId
                ).style.display = "none";
            }

            function hideApprovalForm(expenseId) {
                document.getElementById(
                    "approval-form-" + expenseId
                ).style.display = "none";
            }

            function showRejectionForm(expenseId) {
                document.getElementById(
                    "rejection-form-" + expenseId
                ).style.display = "block";
                document.getElementById(
                    "approval-form-" + expenseId
                ).style.display = "none";
            }

            function hideRejectionForm(expenseId) {
                document.getElementById(
                    "rejection-form-" + expenseId
                ).style.display = "none";
            }
        </script>
    </body>
</html>
