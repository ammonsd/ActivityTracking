<!DOCTYPE html>
<html
    lang="en"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>User Management</title>
        
        <!-- Favicon -->
        <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}" />
        <link rel="icon" type="image/png" sizes="32x32" th:href="@{/favicon-32x32.png}" />
        <link rel="icon" type="image/png" sizes="16x16" th:href="@{/favicon-16x16.png}" />
        <link rel="apple-touch-icon" sizes="180x180" th:href="@{/apple-touch-icon.png}" />
        <link rel="manifest" th:href="@{/site.webmanifest}" />
        
        <link rel="stylesheet" th:href="@{/css/base.css}" />
        <link rel="stylesheet" th:href="@{/css/components.css}" />
        
        <style>
            /* Page-specific styles */
            .container {
                max-width: 1600px;
            }
            .btn-primary:hover {
                background-color: #0056b3;
            }
            .btn-secondary:hover {
                background-color: #545b62;
            }
            .btn-warning:hover {
                background-color: #e0a800;
            }
            .btn-danger:hover {
                background-color: #c82333;
            }
            .btn-disabled {
                background-color: #6c757d;
                color: #fff;
                opacity: 0.5;
                cursor: not-allowed;
                pointer-events: none;
            }
            .btn-info:hover {
                background-color: #138496;
            }
            .users-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            .users-table th,
            .users-table td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }
            .users-table th {
                background-color: #f8f9fa;
                font-weight: bold;
                color: #495057;
            }
            .users-table tr:hover {
                background-color: #f5f5f5;
            }
            .role-badge {
                padding: 0.25rem 0.5rem;
                border-radius: 3px;
                font-size: 0.75rem;
                font-weight: bold;
            }
            .role-admin {
                background-color: #dc3545;
                color: white;
            }
            .role-user {
                background-color: #17a2b8;
                color: white;
            }
            .role-guest {
                background-color: #6c757d;
                color: white;
            }
            .role-EXPENSE_ADMIN {
                background-color: #ffc107;
                color: #212529;
            }
            .status-enabled {
                color: #28a745;
                font-weight: bold;
            }
            .status-disabled {
                color: #dc3545;
                font-weight: bold;
            }
            .actions {
                display: flex;
                gap: 5px;
                flex-wrap: nowrap;
                align-items: center;
            }
            .actions form {
                margin: 0;
                display: inline-flex;
            }
            @media (max-width: 768px) {
                .actions {
                    flex-direction: column;
                }
                .users-table {
                    font-size: 14px;
                }
                .users-table th,
                .users-table td {
                    padding: 8px;
                }
            }
            /* Custom confirmation modal styles */
            .modal-content h3 {
                color: #dc3545;
                margin-top: 0;
                margin-bottom: 15px;
            }
            .modal-content p {
                margin-bottom: 25px;
                color: #333;
            }
            /* Filter section styles */
            .filter-section {
                background-color: #f8f9fa;
                padding: 20px;
                border-radius: 5px;
                margin-bottom: 20px;
                border: 1px solid #dee2e6;
            }
            .filter-section h3 {
                margin-top: 0;
                margin-bottom: 15px;
                color: #495057;
                font-size: 1.1rem;
            }
            .filter-row {
                display: flex;
                gap: 15px;
                align-items: flex-end;
                flex-wrap: wrap;
            }
            .filter-group {
                flex: 1;
                min-width: 200px;
            }
            .filter-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 500;
                color: #495057;
            }
            .filter-group input,
            .filter-group select {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #ced4da;
                border-radius: 4px;
                font-size: 14px;
            }
            .filter-buttons {
                display: flex;
                gap: 10px;
            }
            @media (max-width: 768px) {
                .filter-row {
                    flex-direction: column;
                }
                .filter-group {
                    width: 100%;
                }
                .filter-buttons {
                    width: 100%;
                    flex-direction: column;
                }
                .filter-buttons button {
                    width: 100%;
                }
            }
        </style>
    </head>
    <body>
        <nav class="navbar">
            <div class="nav-content">
                <h1>Task Activity Tracker</h1>
                <div class="user-info">
                    <span class="welcome-text">
                        <span th:text="${userDisplayName}">Username</span>
                    </span>
                    <form
                        th:action="@{/logout}"
                        method="post"
                        style="display: inline"
                    >
                        <button type="submit" class="btn btn-secondary btn-sm">
                            Logout
                        </button>
                    </form>
                    <span class="current-date" style="margin-left: 15px; font-size: 14px;">
                        <script>
                            document.write(new Date().toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' }));
                        </script>
                    </span>
                </div>
            </div>
        </nav>

        <div class="container">
            <div class="header">
                <h1>User Management</h1>
                <div>
                    <a
                        th:href="@{/task-activity/manage-users/add}"
                        class="btn btn-primary"
                        >Add New User</a
                    >
                    <a
                        th:href="@{/task-activity/manage-users/notify}"
                        class="btn btn-info"
                        >Notify Users</a
                    >
                    <a
                        th:href="@{/task-activity/list}"
                        class="btn btn-secondary"
                        >Task Activity List</a
                    >
                </div>
            </div>

            <div class="content">
                <!-- Filter Section -->
                <div class="filter-section">
                    <h3>üîç Filter Users</h3>
                    <form th:action="@{/task-activity/manage-users}" method="get">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="username">Username</label>
                                <input
                                    type="text"
                                    id="username"
                                    name="username"
                                    th:value="${filterUsername}"
                                    placeholder="Search by username..."
                                />
                            </div>
                            <div class="filter-group">
                                <label for="role">Role</label>
                                <select id="role" name="role">
                                    <option value="">-- All Roles --</option>
                                    <option
                                        th:each="r : ${roles}"
                                        th:value="${r.name}"
                                        th:text="${r.name}"
                                        th:selected="${r.name == filterRole}"
                                    ></option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="company">Company</label>
                                <input
                                    type="text"
                                    id="company"
                                    name="company"
                                    th:value="${filterCompany}"
                                    placeholder="Search by company..."
                                />
                            </div>
                            <div class="filter-buttons">
                                <button type="submit" class="btn btn-primary">
                                    Search
                                </button>
                                <a
                                    th:href="@{/task-activity/manage-users}"
                                    class="btn btn-secondary"
                                    >Reset</a
                                >
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Success Message -->
                <div
                    th:if="${successMessage}"
                    class="success-message"
                    th:text="${successMessage}"
                ></div>

                <!-- Error Message -->
                <div
                    th:if="${errorMessage}"
                    class="error-message"
                    th:text="${errorMessage}"
                ></div>

                <div th:if="${#lists.isEmpty(users)}" class="error-message">
                    No users found in the system.
                </div>

                <table th:if="${!#lists.isEmpty(users)}" class="users-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Company</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created Date <span style="font-size: 0.85em; font-weight: normal;">(Local)</span></th>
                            <th>Last Login <span style="font-size: 0.85em; font-weight: normal;">(Local)</span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="user : ${users}">
                            <td th:text="${user.username}">admin</td>
                            <td th:text="${user.company ?: '-'}">Company Name</td>
                            <td th:text="${user.email != null && !#strings.isEmpty(user.email) ? user.email : '-'}"
                                th:style="${user.email == null || #strings.isEmpty(user.email) ? 'color: #dc3545; font-style: italic;' : ''}"
                            >user@example.com</td>
                            <td>
                                <span
                                    th:class="${'role-badge ' + (user.role.name == 'ADMIN' ? 'role-admin' : (user.role.name == 'GUEST' ? 'role-guest' : (user.role.name == 'EXPENSE_ADMIN' ? 'role-EXPENSE_ADMIN' : 'role-user')))}"
                                    th:text="${user.role.name}"
                                    >ADMIN</span
                                >
                            </td>
                            <td>
                                <span
                                    th:class="${user.enabled ? 'status-enabled' : 'status-disabled'}"
                                    th:text="${user.enabled ? 'Enabled' : 'Disabled'}"
                                    >Enabled</span
                                >
                                <span
                                    th:if="${user.accountLocked}"
                                    class="status-disabled"
                                    style="display: block; margin-top: 3px; font-size: 11px;"
                                    title="Account locked due to failed login attempts"
                                    >üîí Locked</span
                                >
                            </td>
                            <td
                                class="utc-time"
                                th:attr="data-utc-time=${#temporals.format(user.createdDate, 'yyyy-MM-dd HH:mm')}"
                                th:text="${#temporals.format(user.createdDate, 'yyyy-MM-dd HH:mm')}"
                            >
                                2023-12-01 10:00
                            </td>
                            <td
                                class="utc-time"
                                th:attr="data-utc-time=${user.lastLogin != null ? #temporals.format(user.lastLogin, 'yyyy-MM-dd HH:mm') : 'Never'}"
                                th:text="${user.lastLogin != null ? #temporals.format(user.lastLogin, 'yyyy-MM-dd HH:mm') : 'Never'}"
                            >
                                2023-12-01 10:00
                            </td>
                            <td>
                                <div class="actions">
                                    <a
                                        th:href="@{/task-activity/manage-users/edit/{id}(id=${user.id})}"
                                        class="btn btn-warning btn-sm"
                                        >Edit</a
                                    >
                                    <a
                                        th:href="@{/task-activity/manage-users/change-password/{id}(id=${user.id})}"
                                        class="btn btn-info btn-sm"
                                        >Password</a
                                    >
                                    <!-- Access button disabled for ADMIN (role has full access) -->
                                    <span
                                        th:if="${user.role != null && user.role.name == 'ADMIN'}"
                                        class="btn btn-disabled btn-sm"
                                        title="ADMIN role already has full access to all dropdowns"
                                        >Access</span
                                    >
                                    <a
                                        th:unless="${user.role != null && user.role.name == 'ADMIN'}"
                                        th:href="@{/task-activity/manage-users/access/{un}(un=${user.username})}"
                                        class="btn btn-secondary btn-sm"
                                        >Access</a
                                    >
                                    <!-- Delete button - disabled if user is current user OR has task activities -->
                                    <form
                                        th:if="${user.username != username && !userHasTasks[user.username]}"
                                        th:action="@{/task-activity/manage-users/delete/{id}(id=${user.id})}"
                                        method="post"
                                        th:id="'deleteForm-' + ${user.id}"
                                    >
                                        <button
                                            type="button"
                                            class="btn btn-danger btn-sm delete-user-btn"
                                            th:data-user-id="${user.id}"
                                            th:data-username="${user.username}"
                                        >
                                            Delete
                                        </button>
                                    </form>
                                    <!-- Show disabled button with tooltip if user is current user -->
                                    <span
                                        th:if="${user.username == username}"
                                        class="btn btn-disabled btn-sm"
                                        title="Cannot delete your own account"
                                        >Delete</span
                                    >
                                    <!-- Show disabled button with tooltip if user has task activities -->
                                    <span
                                        th:if="${user.username != username && userHasTasks[user.username]}"
                                        class="btn btn-disabled btn-sm"
                                        title="Cannot delete user with existing task entries"
                                        >Delete</span
                                    >
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="deleteModal" class="modal">
            <div class="modal-content">
                <h3>Confirm Deletion</h3>
                <p id="deleteMessage">
                    Are you sure you want to delete this user? This action cannot be undone.
                </p>
                <div class="modal-buttons">
                    <button class="btn btn-danger" onclick="confirmDelete()">
                        Delete
                    </button>
                    <button class="btn btn-secondary" onclick="closeDeleteModal()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <script src="/js/modal-utils.js"></script>
        <script src="/js/utc-time-converter.js"></script>
        <script>
            // Initialize event listeners when page loads
            document.addEventListener("DOMContentLoaded", function () {
                // UTC time conversion is handled automatically by utc-time-converter.js
                
                // Add click event listeners to all delete buttons
                const deleteButtons = document.querySelectorAll(".delete-user-btn");
                deleteButtons.forEach(function (button) {
                    button.addEventListener("click", function () {
                        const userId = this.getAttribute("data-user-id");
                        const username = this.getAttribute("data-username");
                        
                        const formId = "deleteForm-" + userId;
                        const message = "Are you sure you want to delete user '" + username + "'? This action cannot be undone.";
                        openDeleteModal(formId, message);
                    });
                });
            });
        </script>
    </body>
</html>


