<div class="profile-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>account_circle</mat-icon>
        My Profile
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div *ngIf="loading" class="loading-container">
        <mat-spinner></mat-spinner>
      </div>

      <form
        *ngIf="!loading && currentUser"
        #profileForm="ngForm"
        (ngSubmit)="updateProfile()"
      >
        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Username</mat-label>
            <input
              matInput
              [(ngModel)]="currentUser.username"
              name="username"
              disabled
              readonly
            />
            <mat-icon matSuffix>person</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Role</mat-label>
            <input
              matInput
              [value]="roleDisplay"
              name="role"
              disabled
              readonly
            />
            <mat-icon matSuffix>badge</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>First Name</mat-label>
            <input
              matInput
              [(ngModel)]="currentUser.firstname"
              name="firstname"
            />
            <mat-icon matSuffix>person_outline</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Last Name</mat-label>
            <input
              matInput
              [(ngModel)]="currentUser.lastname"
              name="lastname"
              required
            />
            <mat-icon matSuffix>person_outline</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Company</mat-label>
            <input matInput [(ngModel)]="currentUser.company" name="company" />
            <mat-icon matSuffix>business</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Email</mat-label>
            <input
              matInput
              type="email"
              [(ngModel)]="currentUser.email"
              name="email"
            />
            <mat-icon matSuffix>email</mat-icon>
            <mat-hint>Required for expense management features</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button
            type="submit"
            mat-raised-button
            color="primary"
            [disabled]="!profileForm.form.valid || loading"
          >
            <mat-icon>save</mat-icon>
            Update Profile
          </button>

          <button
            type="button"
            mat-raised-button
            color="accent"
            (click)="openPasswordDialog()"
          >
            <mat-icon>lock</mat-icon>
            Update Password
          </button>

          <button
            type="button"
            mat-raised-button
            (click)="cancel()"
          >
            Cancel
          </button>
        </div>
      </form>

      <div *ngIf="!loading && !currentUser" class="error-message">
        <mat-icon>error</mat-icon>
        <p>Unable to load profile information</p>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Update Password Dialog -->
  <div 
    class="password-dialog-overlay" 
    *ngIf="showPasswordDialog" 
    (click)="closePasswordDialog()"
    (keydown.escape)="closePasswordDialog()"
    role="button"
    tabindex="0"
    aria-label="Close password dialog overlay"
  >
    <mat-card 
      class="password-dialog" 
      (click)="$event.stopPropagation()"
      (keydown)="$event.stopPropagation()"
      role="dialog"
      aria-labelledby="password-dialog-title"
    >
      <mat-card-header>
        <mat-card-title>
          <mat-icon>lock</mat-icon>
          Change Password
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form #passwordForm="ngForm" (ngSubmit)="updatePassword()">
          <div class="password-error" *ngIf="passwordError">
            {{ passwordError }}
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Current Password</mat-label>
            <input
              matInput
              [type]="showPasswords ? 'text' : 'password'"
              [(ngModel)]="currentPassword"
              name="currentPassword"
              required
            />
            <mat-icon matSuffix>vpn_key</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>New</mat-label>
            <input
              matInput
              [type]="showPasswords ? 'text' : 'password'"
              [(ngModel)]="newPassword"
              name="newPassword"
              required
              minlength="10"
            />
            <mat-icon matSuffix>vpn_key</mat-icon>
          </mat-form-field>

          <div class="password-requirements">
            <p>Password must be:</p>
            <ul>
              <li>At least 10 characters long</li>
              <li>Include at least 1 uppercase letter</li>
              <li>Include at least 1 digit</li>
              <li>Include at least 1 special character (+&%$#&#64;!~*)</li>
              <li>Not contain more than 2 consecutive identical characters</li>
              <li>Not contain the username (case-insensitive)</li>
              <li>Not be the same as your current password</li>
              <li>Cannot match any of your previous 5 passwords</li>
            </ul>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Confirm</mat-label>
            <input
              matInput
              [type]="showPasswords ? 'text' : 'password'"
              [(ngModel)]="confirmPassword"
              name="confirmPassword"
              required
            />
            <mat-icon matSuffix>vpn_key</mat-icon>
          </mat-form-field>

          <div class="show-passwords-checkbox">
            <mat-checkbox [(ngModel)]="showPasswords" name="showPasswords">
              Show passwords
            </mat-checkbox>
          </div>

          <div class="dialog-actions">
            <button
              type="submit"
              mat-raised-button
              color="primary"
              [disabled]="!passwordForm.form.valid || loading"
            >
              Change Password
            </button>

            <button
              type="button"
              mat-raised-button
              (click)="closePasswordDialog()"
            >
              Cancel
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</div>
