<div class="expense-list-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Expenses</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <!-- Filter Section -->
      <div class="filter-section">
        <mat-form-field appearance="outline">
          <mat-label>Client</mat-label>
          <mat-select
            [(ngModel)]="selectedClient"
            (selectionChange)="applyFilters()"
          >
            <mat-option value="">All Clients</mat-option>
            <mat-option *ngFor="let client of uniqueClients" [value]="client">
              {{ client }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Project</mat-label>
          <mat-select
            [(ngModel)]="selectedProject"
            (selectionChange)="applyFilters()"
          >
            <mat-option value="">All Projects</mat-option>
            <mat-option
              *ngFor="let project of uniqueProjects"
              [value]="project"
            >
              {{ project }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Expense Type</mat-label>
          <mat-select
            [(ngModel)]="selectedExpenseType"
            (selectionChange)="applyFilters()"
          >
            <mat-option value="">All Types</mat-option>
            <mat-option *ngFor="let type of uniqueExpenseTypes" [value]="type">
              {{ type }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select
            [(ngModel)]="selectedStatus"
            (selectionChange)="applyFilters()"
          >
            <mat-option value="">All Statuses</mat-option>
            <mat-option *ngFor="let status of uniqueStatuses" [value]="status">
              {{ status }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Payment Method</mat-label>
          <mat-select
            [(ngModel)]="selectedPaymentMethod"
            (selectionChange)="applyFilters()"
          >
            <mat-option value="">All Methods</mat-option>
            <mat-option
              *ngFor="let method of uniquePaymentMethods"
              [value]="method"
            >
              {{ method }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field
          appearance="outline"
          *ngIf="currentRole === 'ADMIN' || currentRole === 'EXPENSE_ADMIN'"
        >
          <mat-label>Username</mat-label>
          <mat-select
            [(ngModel)]="selectedUsername"
            (selectionChange)="applyFilters()"
          >
            <mat-option value="">All Users</mat-option>
            <mat-option *ngFor="let user of uniqueUsernames" [value]="user">
              {{ user }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Start Date</mat-label>
          <input
            matInput
            [matDatepicker]="startPicker"
            [(ngModel)]="startDate"
            (dateChange)="applyFilters()"
            (click)="startPicker.open()"
            placeholder="MM/DD/YYYY"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="startPicker"
          ></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>End Date</mat-label>
          <input
            matInput
            [matDatepicker]="endPicker"
            [(ngModel)]="endDate"
            (dateChange)="applyFilters()"
            (click)="endPicker.open()"
            placeholder="MM/DD/YYYY"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="endPicker"
          ></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="table-actions">
        <button mat-raised-button color="primary" (click)="addExpense()">
          <mat-icon>add</mat-icon> Add Expense
        </button>
        <button mat-raised-button color="accent" (click)="clearFilters()">
          <mat-icon>clear</mat-icon> Clear Filters
        </button>
      </div>

      <!-- Pagination Controls -->
      <div *ngIf="totalElements > 0 && !loading" class="pagination">
        <button
          *ngIf="totalPages > 1"
          mat-icon-button
          [disabled]="currentPage === 0"
          (click)="goToPage(0)"
          title="First Page"
        >
          <mat-icon>first_page</mat-icon>
        </button>
        <button
          *ngIf="totalPages > 1"
          mat-icon-button
          [disabled]="currentPage === 0"
          (click)="goToPage(currentPage - 1)"
          title="Previous Page"
        >
          <mat-icon>chevron_left</mat-icon>
        </button>

        <span class="pagination-info">
          {{ startEntry }} to {{ endEntry }} of {{ totalElements }}
        </span>

        <button
          *ngIf="totalPages > 1"
          mat-icon-button
          [disabled]="currentPage === totalPages - 1"
          (click)="goToPage(currentPage + 1)"
          title="Next Page"
        >
          <mat-icon>chevron_right</mat-icon>
        </button>
        <button
          *ngIf="totalPages > 1"
          mat-icon-button
          [disabled]="currentPage === totalPages - 1"
          (click)="goToPage(totalPages - 1)"
          title="Last Page"
        >
          <mat-icon>last_page</mat-icon>
        </button>
      </div>

      <div *ngIf="loading" class="loading-spinner">
        <mat-spinner></mat-spinner>
      </div>

      <div *ngIf="error" class="error-message">
        {{ error }}
      </div>

      <table
        mat-table
        [dataSource]="filteredExpenses"
        *ngIf="!loading && !error"
        class="expense-table"
      >
        <ng-container matColumnDef="expenseDate">
          <th mat-header-cell *matHeaderCellDef>Date</th>
          <td mat-cell *matCellDef="let expense">
            {{ expense.expenseDate | date : "M/d/yy" }}
          </td>
        </ng-container>

        <ng-container matColumnDef="client">
          <th mat-header-cell *matHeaderCellDef>Client</th>
          <td mat-cell *matCellDef="let expense">{{ expense.client }}</td>
        </ng-container>

        <ng-container matColumnDef="project">
          <th mat-header-cell *matHeaderCellDef>Project</th>
          <td mat-cell *matCellDef="let expense">
            {{ expense.project || "-" }}
          </td>
        </ng-container>

        <ng-container matColumnDef="expenseType">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let expense">{{ expense.expenseType }}</td>
        </ng-container>

        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Description</th>
          <td mat-cell *matCellDef="let expense">{{ expense.description }}</td>
        </ng-container>

        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>Amount</th>
          <td mat-cell *matCellDef="let expense">
            {{ formatCurrency(expense.amount, expense.currency) }}
          </td>
        </ng-container>

        <ng-container matColumnDef="expenseStatus">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let expense">
            {{ expense.expenseStatus }}
          </td>
        </ng-container>

        <ng-container matColumnDef="username">
          <th mat-header-cell *matHeaderCellDef>Username</th>
          <td mat-cell *matCellDef="let expense">{{ expense.username }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let expense" class="actions-cell">
            <button
              mat-icon-button
              color="primary"
              (click)="editExpense(expense)"
              title="Edit Expense"
            >
              <mat-icon>edit</mat-icon>
            </button>
            <button
              mat-icon-button
              color="accent"
              (click)="cloneExpense(expense)"
              title="Clone Expense"
            >
              <mat-icon>content_copy</mat-icon>
            </button>
            <button
              mat-icon-button
              color="warn"
              (click)="deleteExpense(expense)"
              title="Delete Expense"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>

      <div
        *ngIf="filteredExpenses.length === 0 && !loading && !error"
        class="no-data"
      >
        <p>No expenses found matching the selected filters.</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>
